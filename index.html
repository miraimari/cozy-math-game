<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fun Math App üßÆ</title>
<style>
body { font-family: sans-serif; text-align: center; background: #f0f4f8; }
h1 { margin-top: 10px; }
canvas { border: 2px solid #333; background: white; margin: 5px; touch-action: none; }
button { margin: 10px; padding: 10px 20px; font-size: 18px; }
.stats { margin: 15px; font-size: 18px; }
.digit-boxes { display: flex; justify-content: center; flex-wrap: wrap; }
#badges div { margin: 3px; font-size: 18px; color: green; }
</style>
</head>
<body>
<h1>Fun Math App ‚úèÔ∏è</h1>
<div class="stats">
  <span id="streak">Streak: 0</span> | 
  <span id="dailyStreak">Daily Streak: 0</span> | 
  <span id="xp">XP: 0</span> | 
  <span id="level">Level: 1</span>
</div>
<div id="badges"></div>

<h2 id="question">Loading...</h2>
<div class="digit-boxes" id="digitBoxes"></div>

<button onclick="clearAll()">Clear All</button>
<button onclick="recognizeAll()">Read</button>
<button onclick="submitAll()">Submit</button>
<button onclick="startReview()">Review Missed Questions</button>

<h3 id="recognized">I read: ‚Ä¶</h3>
<h3 id="feedback"></h3>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>

<script>
let model;
async function loadModel() {
  model = await tf.loadLayersModel("https://storage.googleapis.com/tfjs-models/tfjs/mnist/model.json");
  updateDailyStreak();
  newQuestion();
}
loadModel();

// Game state
let streak = 0, xp = 0, level = 1;
let currentAnswer = 0;
let recognizedDigits = [];
let badgesEarned = [];
let firstAttemptWrong = false;

// Review mode state
let reviewMode = false;
let reviewQuestions = [];
let reviewIndex = 0;

const digitBoxesContainer = document.getElementById("digitBoxes");

// Daily streak
function updateDailyStreak() {
  const today = new Date().toDateString();
  const lastPlayed = localStorage.getItem("lastPlayed");
  let dailyStreak = parseInt(localStorage.getItem("dailyStreak")) || 0;

  if(lastPlayed){
    const lastDate = new Date(lastPlayed);
    const diffDays = Math.floor((new Date(today) - lastDate) / (1000*60*60*24));
    if(diffDays === 1) dailyStreak++;
    else if(diffDays > 1) dailyStreak = 1;
  } else dailyStreak = 1;

  localStorage.setItem("dailyStreak", dailyStreak);
  localStorage.setItem("lastPlayed", today);
  document.getElementById("dailyStreak").innerText = "Daily Streak: " + dailyStreak;

  if(dailyStreak === 7) showBadge("7-Day Streak! üåü");
}

// Badges
function showBadge(name) {
  if (!badgesEarned.includes(name)) {
    badgesEarned.push(name);
    const badgeDiv = document.getElementById("badges");
    const badge = document.createElement("div");
    badge.innerText = "üèÖ " + name;
    badgeDiv.appendChild(badge);
  }
}

// Levels
function checkLevelUp() {
  if(xp >= level*20){
    level++;
    document.getElementById("level").innerText = "Level: " + level;
    showBadge("Level Up! üéâ");
  }
}

// Difficulty
function getDifficulty() {
  return Math.min(level-1, 5);
}

// Question generation
function newQuestion() {
  if(reviewMode) return loadReviewQuestion();

  const grade = getDifficulty();
  let maxNum = 10;
  let operations = ["+", "-"];
  if(grade <= 1) maxNum = 10;
  else if(grade <=3) maxNum = 50;
  else maxNum = 200;
  if(grade>=4) operations.push("*");

  let op = operations[Math.floor(Math.random()*operations.length)];
  let a = Math.floor(Math.random()*maxNum)+1;
  let b = Math.floor(Math.random()*maxNum)+1;
  if(op === "-" && b > a) [a,b]=[b,a];

  currentAnswer = op === "+" ? a+b : op === "-" ? a-b : a*b;
  document.getElementById("question").innerText = `${a} ${op} ${b} = ?`;
  recognizedDigits = [];
  firstAttemptWrong = false;
  createDigitBoxes(currentAnswer.toString().length);
  document.getElementById("feedback").innerText = "";
}

// Digit input canvases
function createDigitBoxes(count) {
  digitBoxesContainer.innerHTML = "";
  for(let i=0;i<count;i++){
    let c = document.createElement("canvas");
    c.width = 100; c.height = 100;
    c.id = "canvas"+i;
    digitBoxesContainer.appendChild(c);
    initCanvas(c);
  }
}

function initCanvas(c){
  let ctx = c.getContext("2d");
  ctx.lineWidth = 20; ctx.lineCap = "round"; ctx.strokeStyle = "black";
  let drawing = false;
  c.addEventListener("pointerdown", e=>{drawing=true;draw(e,c,ctx);});
  c.addEventListener("pointermove", e=>{if(drawing) draw(e,c,ctx);});
  c.addEventListener("pointerup", ()=>{drawing=false; ctx.beginPath();});
  c.addEventListener("pointerleave", ()=>{drawing=false; ctx.beginPath();});
}

function draw(e,c,ctx){
  const rect = c.getBoundingClientRect();
  ctx.lineTo(e.clientX-rect.left,e.clientY-rect.top);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(e.clientX-rect.left,e.clientY-rect.top);
}

function clearAll(){
  document.querySelectorAll("canvas").forEach(c=>c.getContext("2d").clearRect(0,0,c.width,c.height));
  recognizedDigits=[];
  document.getElementById("recognized").innerText="I read: ‚Ä¶";
}

// Handwriting recognition
async function recognizeAll(){
  recognizedDigits=[];
  const canvases = document.querySelectorAll("canvas");
  for(let c of canvases){
    let imgData = c.getContext("2d").getImageData(0,0,c.width,c.height);
    let gray = tf.browser.fromPixels(imgData,1);
    let resized = tf.image.resizeBilinear(gray,[28,28]).toFloat().expandDims(0).div(255.0);
    let pred = model.predict(resized).dataSync();
    let digit = pred.indexOf(Math.max(...pred));
    recognizedDigits.push(digit);
    gray.dispose(); resized.dispose();
  }
  document.getElementById("recognized").innerText="I read: "+recognizedDigits.join("");
}

// Missed questions storage
function addMissedQuestion(q, ans){
  let missed = JSON.parse(localStorage.getItem("missedQuestions") || "[]");
  if(!missed.some(item => item.question===q)) {
    missed.push({question: q, answer: ans});
    localStorage.setItem("missedQuestions", JSON.stringify(missed));
  }
}
function removeFromMissed(q){
  let missed = JSON.parse(localStorage.getItem("missedQuestions") || "[]");
  missed = missed.filter(item => item.question !== q);
  localStorage.setItem("missedQuestions", JSON.stringify(missed));
}

// Submit answer
function submitAll(){
  recognizeAll().then(()=>{
    let guess = parseInt(recognizedDigits.join(""));
    
    if(reviewMode){
      if(guess===currentAnswer){
        removeFromMissed(document.getElementById("question").innerText);
        reviewIndex++;
        loadReviewQuestion();
      } else {
        document.getElementById("feedback").innerText="‚ùå Try again!";
      }
      return;
    }
    
    // Normal mode with retry until correct
    if(guess===currentAnswer){
      if(firstAttemptWrong){
        addMissedQuestion(document.getElementById("question").innerText, currentAnswer);
        firstAttemptWrong = false;
      }
      streak++; xp+=5;
      document.getElementById("feedback").innerText="‚úÖ Correct!";
      document.getElementById("streak").innerText="Streak: "+streak;
      document.getElementById("xp").innerText="XP: "+xp;

      // Example badges
      if(streak===3) showBadge("First Streak! üî•");
      if(currentAnswer>10) showBadge("Math Master! üèÜ");
      if(document.getElementById("question").innerText.includes("*")) showBadge("Multiplication Pro! ‚ú®");

      checkLevelUp();
      newQuestion();
    } else {
      document.getElementById("feedback").innerText="‚ùå Try again!";
      firstAttemptWrong = true;
    }
  });
}

// Review mode
function startReview(){
  reviewQuestions = JSON.parse(localStorage.getItem("missedQuestions") || "[]");
  if(reviewQuestions.length === 0){
    alert("No missed questions to review!");
    return;
  }
  reviewMode = true;
  reviewIndex = 0;
  loadReviewQuestion();
}

function loadReviewQuestion(){
  if(reviewIndex >= reviewQuestions.length){
    alert("Review complete! üéâ");
    reviewMode = false;
    newQuestion();
    return;
  }
  let q = reviewQuestions[reviewIndex];
  currentAnswer = q.answer;
  document.getElementById("question").innerText = q.question + " = ?";
  recognizedDigits = [];
  firstAttemptWrong = false;
  createDigitBoxes(currentAnswer.toString().length);
  document.getElementById("feedback").innerText = "";
}
</script>
</body>
</html>
