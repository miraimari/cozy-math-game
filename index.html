<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flash Math (Web)</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #f9fafc; }
    h1 { margin-top: 10px; }
    #canvas { border: 2px solid #333; background: white; touch-action: none; }
    button { margin: 10px; padding: 10px 20px; font-size: 18px; }
    .stats { margin: 15px; font-size: 18px; }
  </style>
</head>
<body>
  <h1>Flash Math ✏️</h1>
  <div class="stats">
    <span id="streak">Streak: 0</span> | 
    <span id="xp">XP: 0</span>
  </div>
  <h2 id="question">Loading...</h2>
  
  <canvas id="canvas" width="280" height="280"></canvas><br>
  <button onclick="clearCanvas()">Clear</button>
  <button onclick="recognize()">Read</button>
  <button onclick="submit()">Submit</button>
  
  <h3 id="recognized">I read: …</h3>
  <h3 id="feedback"></h3>
  
  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.18.0/dist/tf.min.js"></script>
  
  <script>
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    ctx.lineWidth = 20;
    ctx.lineCap = "round";
    ctx.strokeStyle = "black";
    
    let drawing = false;
    canvas.addEventListener("pointerdown", e => { drawing = true; draw(e); });
    canvas.addEventListener("pointermove", e => { if (drawing) draw(e); });
    canvas.addEventListener("pointerup", () => drawing = false);
    canvas.addEventListener("pointerleave", () => drawing = false);
    
    function draw(e) {
      const rect = canvas.getBoundingClientRect();
      ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }
    
    function clearCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.beginPath();
      document.getElementById("recognized").innerText = "I read: …";
    }
    
    // TensorFlow.js MNIST model
    let model;
    async function loadModel() {
      model = await tf.loadLayersModel("https://storage.googleapis.com/tfjs-models/tfjs/mnist/model.json");
      newQuestion();
    }
    loadModel();
    
    let currentAnswer = 0, streak = 0, xp = 0, recognizedDigits = "";
    
    function newQuestion() {
      let a = Math.floor(Math.random() * 10) + 1;
      let b = Math.floor(Math.random() * 10) + 1;
      let op = Math.random() < 0.5 ? "+" : "-";
      if (op === "-" && b > a) [a, b] = [b, a];
      currentAnswer = (op === "+") ? (a + b) : (a - b);
      document.getElementById("question").innerText = `${a} ${op} ${b} = ?`;
      document.getElementById("feedback").innerText = "";
      clearCanvas();
    }
    
    async function recognize() {
      // Grab image data
      let imgData = ctx.getImageData(0, 0, 280, 280);
      // Convert to grayscale
      let gray = tf.browser.fromPixels(imgData, 1);
      let resized = tf.image.resizeBilinear(gray, [28, 28]).toFloat();
      let tensor = resized.expandDims(0).div(255.0);
      // Predict
      let pred = model.predict(tensor).dataSync();
      let digit = pred.indexOf(Math.max(...pred));
      recognizedDigits = digit.toString();
      document.getElementById("recognized").innerText = "I read: " + recognizedDigits;
      gray.dispose(); resized.dispose(); tensor.dispose();
    }
    
    function submit() {
      if (parseInt(recognizedDigits) === currentAnswer) {
        streak++; xp += 5;
        document.getElementById("feedback").innerText = "✅ Correct!";
      } else {
        streak = 0; xp = Math.max(0, xp - 1);
        document.getElementById("feedback").innerText = "❌ Try again!";
      }
      document.getElementById("streak").innerText = "Streak: " + streak;
      document.getElementById("xp").innerText = "XP: " + xp;
      newQuestion();
    }
  </script>
</body>
</html>

