<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cozy Math Game</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: pink;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    .screen { display: none; padding: 20px; }
    .active { display: block; }
    #keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2px;
      justify-items: center;
      margin: 15px auto;
      max-width: 250px;
    }
    #keypad button {
      width: 70px;
      height: 60px;
      font-size: 22px;
      border-radius: 10px;
      cursor: pointer;
    }
    #submitAnswer {
      width: 200px;
      height: 60px;
      font-size: 22px;
      border-radius: 12px;
      background-color: #ff66b2;
      color: white;
      margin-top: 15px;
      cursor: pointer;
    }
    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      margin: 10px;
      cursor: pointer;
      border: 3px solid transparent;
    }
    .avatar.selected {
      border: 3px solid blue;
    }
  </style>
</head>
<body>

  <!-- Load Screen -->
  <div id="loadScreen" class="screen active">
    <h1>ðŸŒ¸ Cozy Math Game ðŸŒ¸</h1>
    <input type="text" id="username" placeholder="Enter your name">
    <br><br>
    <button onclick="startSettings()">Start</button>
    <button onclick="showScreen('topScoresScreen')">Top Scores</button>
    <button onclick="showScreen('avatarScreen')">Avatar</button>
    <p id="streakMessage"></p>
  </div>

  <!-- Settings Screen -->
  <div id="settingsScreen" class="screen">
    <h2>Settings</h2>
    <label>Choose mode:</label><br>
    <select id="modeSelect">
      <option value="addition">Addition</option>
      <option value="subtraction">Subtraction</option>
      <option value="mixed">Mixed</option>
    </select><br><br>

    <label>Max number:</label><br>
    <input type="number" id="maxNumber" value="10"><br><br>

    <button onclick="startGame()">Play</button>
    <button onclick="showScreen('loadScreen')">Back</button>
  </div>

  <!-- Avatar Screen -->
  <div id="avatarScreen" class="screen">
    <h2>Select Your Avatar</h2>
    <div id="avatarChoices">
      <img src="https://raw.githubusercontent.com/miraimari/cozy-math-game/main/avatar1.jpg" class="avatar" onclick="selectAvatar(this)">
      <img src="https://raw.githubusercontent.com/miraimari/cozy-math-game/main/avatar2.jpg" class="avatar" onclick="selectAvatar(this)">
      <img src="https://raw.githubusercontent.com/miraimari/cozy-math-game/main/avatar3.jpg" class="avatar" onclick="selectAvatar(this)">
    </div>
    <br>
    <button onclick="showScreen('loadScreen')">Back</button>
  </div>

  <!-- Game Screen -->
  <div id="gameScreen" class="screen">
    <h2 id="playerDisplay"></h2>
    <img id="playerAvatar" src="" style="width:80px; height:80px; border-radius:10px;">
    <h3 id="equation"></h3>
    <input type="text" id="answer" readonly>
    <div id="keypad"></div>
    <button id="submitAnswer" onclick="checkAnswer()">Submit</button>
    <p id="feedback"></p>
    <p>Game Score: <span id="gameScore">0</span></p>
    <p>Daily Score: <span id="dailyScore">0</span></p>
    <p>Streak: <span id="streakCount">0</span></p>
    <button onclick="endGame()">End Game</button>
  </div>

  <!-- Top Scores Screen -->
  <div id="topScoresScreen" class="screen">
    <h2>Top Scores</h2>
    <div id="topScoresList"></div>
    <button onclick="showScreen('loadScreen')">Back</button>
  </div>

  <script>
    let currentUser = "";
    let currentAvatar = "";
    let streakData = JSON.parse(localStorage.getItem("streakData")) || {};
    let scoreData = JSON.parse(localStorage.getItem("scoreData")) || {};
    let gameScore = 0;
    let correctAnswer = 0;

    function showScreen(id) {
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
      if(id === "topScoresScreen") loadTopScores();
    }

    function startSettings() {
      currentUser = document.getElementById("username").value.trim();
      if(!currentUser) { alert("Enter a name!"); return; }
      if(!streakData[currentUser]) streakData[currentUser] = { streak: 0, lastDate: "" };
      if(!scoreData[currentUser]) scoreData[currentUser] = { dailyScore: 0, lastDate: "", highestStreak: 0, highScore: 0 };
      updateStreakMessage();
      showScreen("settingsScreen");
    }

    function updateStreakMessage() {
      let today = new Date().toDateString();
      let userStreak = streakData[currentUser];
      if(userStreak.lastDate && userStreak.lastDate !== today) {
        let diff = Math.floor((new Date(today) - new Date(userStreak.lastDate)) / (1000*60*60*24));
        if(diff > 1) {
          userStreak.streak = 0;
          document.getElementById("streakMessage").innerText = `ðŸ˜¢ Sorry ${currentUser}, you lost your streak.`;
        } else {
          document.getElementById("streakMessage").innerText = `ðŸ”¥ Welcome back ${currentUser}! Current streak: ${userStreak.streak} days.`;
        }
      }
      localStorage.setItem("streakData", JSON.stringify(streakData));
    }

    function startGame() {
      document.getElementById("playerDisplay").innerText = currentUser;
      document.getElementById("playerAvatar").src = currentAvatar;
      gameScore = 0;
      document.getElementById("gameScore").innerText = gameScore;
      loadDailyScore();
      buildKeypad();
      generateQuestion();
      showScreen("gameScreen");
    }

    function buildKeypad() {
      let keypad = document.getElementById("keypad");
      keypad.innerHTML = "";
      for(let i=1;i<=9;i++) {
        let btn = document.createElement("button");
        btn.innerText = i;
        btn.onclick = () => document.getElementById("answer").value += i;
        keypad.appendChild(btn);
      }
      let zero = document.createElement("button");
      zero.innerText = "0";
      zero.onclick = () => document.getElementById("answer").value += "0";
      keypad.appendChild(zero);

      let clear = document.createElement("button");
      clear.innerText = "C";
      clear.onclick = () => document.getElementById("answer").value = "";
      keypad.appendChild(clear);
    }

    function generateQuestion() {
      let mode = document.getElementById("modeSelect").value;
      let max = parseInt(document.getElementById("maxNumber").value);
      let a = Math.floor(Math.random() * (max+1));
      let b = Math.floor(Math.random() * (max+1));
      if(mode === "addition") {
        correctAnswer = a + b;
        document.getElementById("equation").innerText = `${a} + ${b}`;
      } else if(mode === "subtraction") {
        if(b > a) [a,b] = [b,a];
        correctAnswer = a - b;
        document.getElementById("equation").innerText = `${a} - ${b}`;
      } else {
        if(Math.random() < 0.5) {
          correctAnswer = a + b;
          document.getElementById("equation").innerText = `${a} + ${b}`;
        } else {
          if(b > a) [a,b] = [b,a];
          correctAnswer = a - b;
          document.getElementById("equation").innerText = `${a} - ${b}`;
        }
      }
      document.getElementById("answer").value = "";
    }

    function checkAnswer() {
      let ans = parseInt(document.getElementById("answer").value);
      if(ans === correctAnswer) {
        gameScore++;
        document.getElementById("gameScore").innerText = gameScore;
        updateDailyScore();
        updateStreak();
        document.getElementById("feedback").innerText = `ðŸŽ‰ Awesome, ${currentUser}, that is correct!`;
      } else {
        document.getElementById("feedback").innerText = "âŒ Try again!";
      }
      setTimeout(generateQuestion, 2000);
    }

    function updateDailyScore() {
      let today = new Date().toDateString();
      if(scoreData[currentUser].lastDate !== today) {
        scoreData[currentUser].dailyScore = 0;
        scoreData[currentUser].lastDate = today;
      }
      scoreData[currentUser].dailyScore++;
      if(gameScore > scoreData[currentUser].highScore) {
        scoreData[currentUser].highScore = gameScore;
      }
      localStorage.setItem("scoreData", JSON.stringify(scoreData));
      document.getElementById("dailyScore").innerText = scoreData[currentUser].dailyScore;
    }

    function updateStreak() {
      let today = new Date().toDateString();
      let userStreak = streakData[currentUser];
      if(userStreak.lastDate !== today) {
        let diff = userStreak.lastDate ? Math.floor((new Date(today) - new Date(userStreak.lastDate)) / (1000*60*60*24)) : 1;
        if(diff === 1) userStreak.streak++;
        else userStreak.streak = 1;
        userStreak.lastDate = today;
        if(userStreak.streak > scoreData[currentUser].highestStreak) {
          scoreData[currentUser].highestStreak = userStreak.streak;
        }
        localStorage.setItem("streakData", JSON.stringify(streakData));
        localStorage.setItem("scoreData", JSON.stringify(scoreData));
        document.getElementById("streakCount").innerText = userStreak.streak;
      }
    }

    function loadDailyScore() {
      let today = new Date().toDateString();
      if(scoreData[currentUser].lastDate !== today) {
        scoreData[currentUser].dailyScore = 0;
        scoreData[currentUser].lastDate = today;
      }
      document.getElementById("dailyScore").innerText = scoreData[currentUser].dailyScore;
      document.getElementById("streakCount").innerText = streakData[currentUser].streak;
    }

    function endGame() {
      showScreen("loadScreen");
    }

    function loadTopScores() {
      let list = document.getElementById("topScoresList");
      list.innerHTML = "";
      for(let user in scoreData) {
        let div = document.createElement("div");
        div.innerText = `${user} - High Score: ${scoreData[user].highScore}, Highest Streak: ${scoreData[user].highestStreak}`;
        list.appendChild(div);
      }
    }

    function selectAvatar(img) {
      document.querySelectorAll(".avatar").forEach(a => a.classList.remove("selected"));
      img.classList.add("selected");
      currentAvatar = img.src;
      localStorage.setItem(currentUser + "_avatar", currentAvatar);
    }
  </script>
</body>
</html>
